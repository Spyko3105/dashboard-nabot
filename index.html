<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Bot Discord</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
    <aside class="sidebar">
        <div class="logo">
            <img src="https://cdn-icons-png.flaticon.com/512/5968/5968756.png" alt="Bot Logo" width="48" height="48">
            <span>Mon Bot</span>
        </div>
        <nav>
            <a href="#dashboard" class="active"><i class="fa-solid fa-gauge"></i> Dashboard</a>
            <a href="#commands"><i class="fa-solid fa-terminal"></i> Commandes</a>
            <a href="#stats"><i class="fa-solid fa-chart-bar"></i> Statistiques</a>
            <a href="#settings"><i class="fa-solid fa-cog"></i> Paramètres</a>
        </nav>
        <div class="sidebar-footer">
            <button class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Déconnexion</button>
        </div>
    </aside>
    <div class="main-content">
        <header>
            <div class="server-select">
                <select>
                    <option>Sélectionner un serveur</option>
                    <option>Serveur 1</option>
                    <option>Serveur 2</option>
                </select>
            </div>
            <div class="status-bar">
                <span class="status online"><i class="fa-solid fa-circle"></i> Bot en ligne</span>
                <button class="btn-login"><i class="fa-brands fa-discord"></i> Se connecter</button>
            </div>
        </header>
        <main>
            <section id="dashboard" class="dashboard-section">
                <h2>Tableau de bord</h2>
                <div class="dashboard-cards">
                    <div class="card">
                        <h3>Serveurs</h3>
                        <p class="number">3</p>
                    </div>
                    <div class="card">
                        <h3>Utilisateurs</h3>
                        <p class="number">128</p>
                    </div>
                    <div class="card">
                        <h3>Commandes</h3>
                        <p class="number">24</p>
                    </div>
                </div>
                <div class="discordjs-info">
                    <h3>Intégration avec discord.js</h3>
                    <p>
                        Pour connecter ce dashboard à votre bot Discord, vous devez utiliser <b>discord.js</b> côté serveur.<br>
                        Exemple de base :
                    </p>
<pre><code class="language-js">
// index.js (Node.js)
const { Client, GatewayIntentBits } = require('discord.js');
const client = new Client({ intents: [GatewayIntentBits.Guilds] });

client.once('ready', () => {
    console.log(`Connecté en tant que ${client.user.tag}`);
});

client.login('VOTRE_TOKEN_BOT');
</code></pre>
                    <p>
                        Pour une intégration OAuth2 complète (connexion utilisateur, gestion des serveurs, etc.), il faut un backend Node.js qui gère les échanges avec l'API Discord.<br>
                        <a href="https://discordjs.guide/oauth2/" target="_blank">Voir la documentation OAuth2 discord.js</a>
                    </p>
                </div>
            </section>
            <section id="commands" class="dashboard-section">
                <h2>Commandes</h2>
                <table class="commands-table">
                    <thead>
                        <tr>
                            <th>Commande</th>
                            <th>Description</th>
                            <th>Activer</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>/ban</td>
                            <td>Bannir un utilisateur</td>
                            <td><input type="checkbox" checked></td>
                        </tr>
                        <tr>
                            <td>/kick</td>
                            <td>Exclure un utilisateur</td>
                            <td><input type="checkbox" checked></td>
                        </tr>
                        <tr>
                            <td>/help</td>
                            <td>Afficher l'aide</td>
                            <td><input type="checkbox" checked></td>
                        </tr>
                    </tbody>
                </table>
            </section>
            <section id="stats" class="dashboard-section">
                <h2>Statistiques</h2>
                <div class="stats-graph">
                    <img src="https://quickchart.io/chart?c={type:'bar',data:{labels:['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'],datasets:[{label:'Commandes',data:[12,19,3,5,2,3,7]}]}}" alt="Graphique des commandes" style="width:100%;max-width:500px;">
                </div>
            </section>
            <section id="settings" class="dashboard-section">
                <h2>Paramètres</h2>
                <form class="settings-form">
                    <label>
                        Préfixe du bot :
                        <input type="text" value="!">
                    </label>
                    <label>
                        Message de bienvenue :
                        <input type="text" value="Bienvenue sur le serveur !">
                    </label>
                    <button type="submit">Enregistrer</button>
                </form>
            </section>
        </main>
        <footer>
            <p>&copy; 2023 Mon Bot Discord - Dashboard</p>
        </footer>
    </div>
    <script>
        const CLIENT_ID = '1361826455406772408';
        const REDIRECT_URI = 'https://dashboard-nabot.vercel.app/';
        const SCOPE = 'guilds identify';

        function showUser(user) {
            const statusBar = document.querySelector('.status-bar');
            statusBar.innerHTML = `
                <span class="status online"><i class="fa-solid fa-circle"></i> Connecté !</span>
                <span class="discord-user">
                    <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" alt="avatar" style="width:32px;height:32px;border-radius:50%;vertical-align:middle;margin-right:8px;">
                    <b>${user.username}#${user.discriminator}</b>
                </span>
            `;
        }

        function hasAdmin(permissions) {
            // 0x8 = ADMINISTRATOR
            return (BigInt(permissions) & 0x8n) === 0x8n;
        }

        // Simulez ici les serveurs où le bot est déjà présent (à remplacer par votre backend)
        function isBotInGuild(guildId) {
            // Par exemple, le bot est sur les 2 premiers serveurs de la liste
            // Remplacez cette logique par un appel backend réel
            const botGuilds = window._botGuilds || [];
            return botGuilds.includes(guildId);
        }

        function showGuilds(guilds) {
            // Simulez la liste des serveurs où le bot est déjà (à remplacer par backend)
            // window._botGuilds = ['id1', 'id2', ...];
            // Pour la démo, on prend les 2 premiers serveurs
            window._botGuilds = guilds.slice(0, 2).map(g => g.id);

            let html = `
                <div class="guilds-list" style="margin-top:16px;">
                    <h4>Vos serveurs Discord</h4>
                    <ul style="list-style:none;padding:0;">
                        ${guilds.map(guild => {
                            const admin = hasAdmin(guild.permissions);
                            const botIn = isBotInGuild(guild.id);
                            return `
                                <li style="margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;background:#23272a;padding:10px 14px;border-radius:8px;">
                                    <div style="display:flex;align-items:center;">
                                        <img src="https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png" alt="icon" style="width:32px;height:32px;border-radius:50%;margin-right:10px;background:#2c2f33;">
                                        <span style="font-weight:600;">${guild.name}</span>
                                        ${admin ? '<span title="Admin" style="color:#43b581;margin-left:8px;"><i class="fa-solid fa-shield-halved"></i></span>' : ''}
                                    </div>
                                    <div>
                                        ${botIn
                                            ? '<span title="Le bot est déjà sur ce serveur" style="color:#5865f2;font-size:1.2em;"><i class="fa-brands fa-discord"></i></span>'
                                            : `<button class="add-bot-btn" data-guild="${guild.id}" style="background:#5865f2;color:#fff;border:none;padding:6px 14px;border-radius:5px;cursor:pointer;font-weight:600;">Ajouter le bot</button>`
                                        }
                                    </div>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </div>
            `;
            // Supprime l'ancienne liste si elle existe
            document.querySelectorAll('.guilds-list').forEach(e => e.remove());
            const statusBar = document.querySelector('.status-bar');
            statusBar.insertAdjacentHTML('afterend', html);

            // Ajoute l'événement sur les boutons "Ajouter le bot"
            document.querySelectorAll('.add-bot-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const guildId = this.getAttribute('data-guild');
                    const inviteUrl = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&scope=bot+applications.commands&permissions=8&guild_id=${guildId}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code`;
                    window.open(inviteUrl, '_blank');
                });
            });
        }

        document.querySelectorAll('.btn-login').forEach(btn => {
            btn.addEventListener('click', () => {
                // Utilisez response_type=token pour pouvoir récupérer le token côté front
                const discordAuth = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(SCOPE)}`;
                window.location.href = discordAuth;
            });
        });

        // --- AJOUT : Récupération des stats, utilisateurs et commandes depuis le backend du bot ---
        function updateDashboardStats(stats) {
            document.querySelector('.dashboard-cards .card:nth-child(1) .number').textContent = stats.guilds ?? '-';
            document.querySelector('.dashboard-cards .card:nth-child(2) .number').textContent = stats.users ?? '-';
            document.querySelector('.dashboard-cards .card:nth-child(3) .number').textContent = stats.commands ?? '-';
        }

        function updateCommands(commands) {
            const tbody = document.querySelector('.commands-table tbody');
            tbody.innerHTML = commands.map(cmd => `
                <tr>
                    <td>${cmd.name}</td>
                    <td>${cmd.description}</td>
                    <td><input type="checkbox" ${cmd.enabled ? 'checked' : ''} disabled></td>
                </tr>
            `).join('');
        }

        // Exemple d'appel à votre backend Node.js relié au bot Discord
        function fetchBotData() {
            fetch('http://127.0.0.1:3000/api/dashboard') // À adapter selon votre backend
                .then(res => res.json())
                .then(data => {
                    if (data.stats) updateDashboardStats(data.stats);
                    if (data.commands) updateCommands(data.commands);
                    // Pour la liste des serveurs où le bot est, mettez à jour window._botGuilds
                    if (data.botGuilds) window._botGuilds = data.botGuilds;
                })
                .catch(() => {
                    // Optionnel : afficher une erreur ou laisser les valeurs par défaut
                });
        }

        // Gestion de la connexion utilisateur après redirection OAuth2
        window.addEventListener('load', () => {
            fetchBotData(); // Met à jour stats, users, commandes, guilds du bot
            if (window.location.hash) {
                const params = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = params.get('access_token');
                if (accessToken) {
                    fetch('https://discord.com/api/users/@me', {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        }
                    })
                    .then(res => res.json())
                    .then(user => {
                        showUser(user);
                        fetch('https://discord.com/api/users/@me/guilds', {
                            headers: {
                                'Authorization': 'Bearer ' + accessToken
                            }
                        })
                        .then(res => res.json())
                        .then(guilds => {
                            showGuilds(guilds);
                        });
                    })
                    .catch(() => {
                        alert("Erreur lors de la récupération du profil Discord.");
                    });
                }
            }
        });
    </script>
</body>
</html>
